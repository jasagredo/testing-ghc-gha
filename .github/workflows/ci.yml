name: Debugging with tmate

on: [push]

jobs:

  build:

    strategy:
      fail-fast: false
      matrix:
        ghc: ["9.2.8"]
        cabal: ["3.10.1.0"]
        sys:
          - { os: windows-latest, shell: 'C:/msys64/usr/bin/bash.exe -e {0}' }
    defaults:
        run:
          shell: ${{ matrix.sys.shell }}
    
    env:
      MSYSTEM: MINGW64
      # do not ever change to $HOME by yourself.
      CHERE_INVOKING: 1
      # do we want to inherit the path?
      MSYS2_PATH_TYPE: inherit
      # Modify this value to "invalidate" the secp cache.
      SECP_CACHE_VERSION: "2022-12-30"
      # current ref from: 27.02.2022
      SECP256K1_REF: ac83be33d0956faf6b7f61a60ab524ef7d6a473a

    runs-on: windows-latest

    steps:

    - name: Install Haskell
      uses: input-output-hk/setup-haskell@0426c24f24770f5b2b0c8575f326272645b877b4
      with:
        ghc-version: ${{ matrix.ghc }}
        cabal-version: ${{ matrix.cabal }}

    - name: Install Base libs
      uses: input-output-hk/actions/base@latest
      with:
        use-sodium-vrf: false

    - name: Install packages via pacman
      run: pacman -S mingw-w64-x86_64-libsodium

    - name: Checkout node
      uses: actions/checkout@v3
      with:
        repository: input-output-hk/cardano-node
      
    - name: Move project.local
      run: mv .github/workflows/cabal.project.local.MINGW64_NT-10.0-20348 cabal.project.local

    - name: Cabal update
      run: cabal update

    - name: Dry-run
      continue-on-error: true
      run: cabal build all --dry-run

    - name: Build core
      continue-on-error: true
      run: cabal build cardano-node cardano-cli cardano-node-chairman cardano-submit-api -j1

    - name: Build others
      continue-on-error: true
      run: cabal build all

    - name: Test
      continue-on-error: true
      run: cabal test cardano-testnet cardano-node cardano-node-chairman cardano-cli cardano-submit-api

    - name: Setup tmate session
      uses: mxschmitt/action-tmate@v3
      with:
        limit-access-to-actor: true
