name: Debugging with tmate

on: [push]

jobs:

  build:

    strategy:
      fail-fast: false
      matrix:
        ghc: ["9.2.8"]
        cabal: ["3.10.1.0"]
        sys:
          - { os: windows-latest, shell: 'C:/msys64/usr/bin/bash.exe -e {0}' }
          - { os: ubuntu-latest, shell: bash }
          - { os: macos-latest, shell: bash }
    defaults:
        run:
          shell: ${{ matrix.sys.shell }}
    
    env:
      MSYSTEM: MINGW64
      # do not ever change to $HOME by yourself.
      CHERE_INVOKING: 1
      # do we want to inherit the path?
      MSYS2_PATH_TYPE: inherit
      # Modify this value to "invalidate" the secp cache.
      SECP_CACHE_VERSION: "2022-12-30"
      # current ref from: 27.02.2022
      SECP256K1_REF: ac83be33d0956faf6b7f61a60ab524ef7d6a473a

    runs-on: ${{ matrix.sys.os }}

    steps:
    - name: Install Base libs
      uses: input-output-hk/actions/base@3632f10856ba59c1b60be28bedf336166c08a855
      with:
        use-sodium-vrf: false

    - name: Install Haskell
      uses: input-output-hk/actions/haskell@3632f10856ba59c1b60be28bedf336166c08a855
      with:
        ghc-version: ${{ matrix.ghc }}
        cabal-version: ${{ matrix.cabal }}

    - name: Checkout node
      uses: actions/checkout@v3
      with:
        repository: input-output-hk/cardano-node
      
    - name: Move project.local
      run: |
        if [[ '${{ runner.os }}' == 'Windows' ]]; then
          mv .github/workflows/cabal.project.local.ci.MINGW64_NT-10.0-20348 cabal.project.local
        elif [[ '${{ runner.os }}' == 'Linux' ]]; then
          mv .github/workflows/cabal.project.local.ci.Linux cabal.project.local
        else 
          mv .github/workflows/cabal.project.local.ci.Darwin cabal.project.local
        fi

    - name: Cabal update
      run: cabal update

    - name: Dry run
      run: cabal build all --dry-run

    - name: Build core
      run: cabal build cardano-node cardano-cli cardano-node-chairman cardano-submit-api -j1

    - name: Build others
      run: cabal build all

    - name: Test
      run: cabal test cardano-testnet cardano-node cardano-node-chairman cardano-submit-api

